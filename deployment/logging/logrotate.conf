# Logrotate configuration for ORM Capital Calculator Engine
# This ensures compliance with CERT-In log retention requirements (180+ days)

# Application logs
/var/log/orm-calculator/*.log {
    daily
    rotate 180
    compress
    delaycompress
    missingok
    notifempty
    create 0644 orm-calculator orm-calculator
    postrotate
        # Send SIGUSR1 to application to reopen log files
        /bin/kill -USR1 $(cat /var/run/orm-calculator.pid 2>/dev/null) 2>/dev/null || true
    endscript
}

# Audit logs (critical for compliance)
/var/log/orm-calculator/audit/*.log {
    daily
    rotate 365
    compress
    delaycompress
    missingok
    notifempty
    create 0600 orm-calculator orm-calculator
    # No postrotate for audit logs to maintain integrity
}

# Security logs
/var/log/orm-calculator/security/*.log {
    daily
    rotate 365
    compress
    delaycompress
    missingok
    notifempty
    create 0600 orm-calculator orm-calculator
    postrotate
        # Notify security monitoring system
        /usr/local/bin/notify-security-log-rotation.sh
    endscript
}

# Performance logs
/var/log/orm-calculator/performance/*.log {
    weekly
    rotate 52
    compress
    delaycompress
    missingok
    notifempty
    create 0644 orm-calculator orm-calculator
}

# Error logs (keep longer for troubleshooting)
/var/log/orm-calculator/error/*.log {
    daily
    rotate 90
    compress
    delaycompress
    missingok
    notifempty
    create 0644 orm-calculator orm-calculator
    postrotate
        # Alert on error log rotation (indicates errors occurred)
        if [ -s "$1" ]; then
            /usr/local/bin/alert-error-log-rotation.sh "$1"
        fi
    endscript
}

# Access logs
/var/log/orm-calculator/access/*.log {
    daily
    rotate 30
    compress
    delaycompress
    missingok
    notifempty
    create 0644 orm-calculator orm-calculator
}

# Database logs
/var/log/postgresql/*.log {
    daily
    rotate 90
    compress
    delaycompress
    missingok
    notifempty
    create 0640 postgres postgres
    postrotate
        # Reload PostgreSQL to reopen log files
        /usr/bin/systemctl reload postgresql
    endscript
}

# Nginx logs
/var/log/nginx/*.log {
    daily
    rotate 30
    compress
    delaycompress
    missingok
    notifempty
    create 0644 www-data www-data
    postrotate
        # Reload Nginx to reopen log files
        /usr/bin/systemctl reload nginx
    endscript
}

# Redis logs
/var/log/redis/*.log {
    weekly
    rotate 12
    compress
    delaycompress
    missingok
    notifempty
    create 0640 redis redis
}