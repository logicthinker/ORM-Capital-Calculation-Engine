# Fluentd configuration for ORM Capital Calculator Engine
# Provides structured log collection and forwarding for compliance and monitoring

# Input sources
<source>
  @type tail
  @id application_logs
  path /var/log/orm-calculator/application.log
  pos_file /var/log/fluentd/application.log.pos
  tag orm.application
  format json
  time_key timestamp
  time_format %Y-%m-%dT%H:%M:%S.%L%z
  keep_time_key true
  read_from_head true
</source>

<source>
  @type tail
  @id audit_logs
  path /var/log/orm-calculator/audit/audit.log
  pos_file /var/log/fluentd/audit.log.pos
  tag orm.audit
  format json
  time_key timestamp
  time_format %Y-%m-%dT%H:%M:%S.%L%z
  keep_time_key true
  read_from_head true
</source>

<source>
  @type tail
  @id security_logs
  path /var/log/orm-calculator/security/security.log
  pos_file /var/log/fluentd/security.log.pos
  tag orm.security
  format json
  time_key timestamp
  time_format %Y-%m-%dT%H:%M:%S.%L%z
  keep_time_key true
  read_from_head true
</source>

<source>
  @type tail
  @id error_logs
  path /var/log/orm-calculator/error/application-error.log
  pos_file /var/log/fluentd/error.log.pos
  tag orm.error
  format json
  time_key timestamp
  time_format %Y-%m-%dT%H:%M:%S.%L%z
  keep_time_key true
  read_from_head true
</source>

<source>
  @type tail
  @id access_logs
  path /var/log/orm-calculator/access/access.log
  pos_file /var/log/fluentd/access.log.pos
  tag orm.access
  format json
  time_key timestamp
  time_format %Y-%m-%dT%H:%M:%S.%L%z
  keep_time_key true
  read_from_head true
</source>

<source>
  @type tail
  @id performance_logs
  path /var/log/orm-calculator/performance/performance.log
  pos_file /var/log/fluentd/performance.log.pos
  tag orm.performance
  format json
  time_key timestamp
  time_format %Y-%m-%dT%H:%M:%S.%L%z
  keep_time_key true
  read_from_head true
</source>

# Database logs
<source>
  @type tail
  @id postgresql_logs
  path /var/log/postgresql/postgresql-*.log
  pos_file /var/log/fluentd/postgresql.log.pos
  tag orm.database.postgresql
  format multiline
  format_firstline /^\d{4}-\d{2}-\d{2} \d{2}:\d{2}:\d{2}.\d{3}/
  format1 /^(?<timestamp>\d{4}-\d{2}-\d{2} \d{2}:\d{2}:\d{2}.\d{3}) (?<timezone>\w+) \[(?<pid>\d+)\] (?<level>\w+):  (?<message>.*)/
  time_key timestamp
  time_format %Y-%m-%d %H:%M:%S.%L
  keep_time_key true
</source>

# Nginx access logs
<source>
  @type tail
  @id nginx_access
  path /var/log/nginx/access.log
  pos_file /var/log/fluentd/nginx_access.log.pos
  tag orm.nginx.access
  format nginx
  keep_time_key true
</source>

# Nginx error logs
<source>
  @type tail
  @id nginx_error
  path /var/log/nginx/error.log
  pos_file /var/log/fluentd/nginx_error.log.pos
  tag orm.nginx.error
  format /^(?<timestamp>\d{4}/\d{2}/\d{2} \d{2}:\d{2}:\d{2}) \[(?<level>\w+)\] (?<pid>\d+)#(?<tid>\d+): (?<message>.*)/
  time_key timestamp
  time_format %Y/%m/%d %H:%M:%S
  keep_time_key true
</source>

# System logs
<source>
  @type systemd
  @id systemd_logs
  tag orm.system
  path /var/log/journal
  matches [{ "_SYSTEMD_UNIT": "orm-calculator.service" }]
  read_from_head true
  strip_underscores true
</source>

# Filters for log processing
<filter orm.**>
  @type record_transformer
  <record>
    hostname "#{Socket.gethostname}"
    environment "#{ENV['ENVIRONMENT'] || 'production'}"
    service_name "orm-capital-calculator"
    compliance_tags ["rbi", "cert-in", "basel-iii"]
    data_residency "india"
  </record>
</filter>

# Add severity levels for better alerting
<filter orm.error>
  @type record_transformer
  <record>
    severity "error"
    alert_required true
  </record>
</filter>

<filter orm.security>
  @type record_transformer
  <record>
    severity "warning"
    alert_required true
    compliance_critical true
  </record>
</filter>

<filter orm.audit>
  @type record_transformer
  <record>
    severity "info"
    compliance_critical true
    retention_required true
    retention_days 365
  </record>
</filter>

# Parse structured application logs
<filter orm.application>
  @type parser
  key_name message
  reserve_data true
  <parse>
    @type json
  </parse>
</filter>

# Geoip enrichment for access logs
<filter orm.access>
  @type geoip
  geoip_lookup_keys remote_addr
  <record>
    location_country ${country_name["remote_addr"]}
    location_region ${region_name["remote_addr"]}
    location_city ${city_name["remote_addr"]}
  </record>
  skip_adding_null_record true
</filter>

# Output configurations
# Local storage for compliance (180+ days retention)
<match orm.audit>
  @type file
  @id audit_file_output
  path /var/log/orm-calculator/fluentd/audit/audit
  append true
  time_slice_format %Y%m%d
  time_slice_wait 10m
  time_format %Y-%m-%dT%H:%M:%S.%L%z
  buffer_type file
  buffer_path /var/log/fluentd/buffer/audit
  flush_interval 10s
  buffer_chunk_limit 64m
  buffer_queue_limit 128
  format json
  include_time_key true
  compress gzip
</match>

# Security logs to SOC and local storage
<match orm.security>
  @type copy
  <store>
    @type forward
    @id security_soc_forward
    <server>
      name soc-server
      host soc.your-company.com
      port 24224
      weight 60
    </server>
    <buffer>
      @type file
      path /var/log/fluentd/buffer/security
      flush_mode interval
      flush_interval 5s
      chunk_limit_size 64m
      queue_limit_length 128
      retry_type exponential_backoff
      retry_wait 1s
      retry_max_interval 60s
      retry_max_times 10
    </buffer>
  </store>
  <store>
    @type file
    @id security_file_output
    path /var/log/orm-calculator/fluentd/security/security
    append true
    time_slice_format %Y%m%d
    time_slice_wait 10m
    format json
    include_time_key true
    compress gzip
  </store>
</match>

# Error logs to monitoring system
<match orm.error>
  @type copy
  <store>
    @type forward
    @id error_monitoring_forward
    <server>
      name monitoring-server
      host monitoring.your-company.com
      port 24224
      weight 60
    </server>
    <buffer>
      @type file
      path /var/log/fluentd/buffer/error
      flush_mode interval
      flush_interval 10s
      chunk_limit_size 64m
      queue_limit_length 128
    </buffer>
  </store>
  <store>
    @type file
    @id error_file_output
    path /var/log/orm-calculator/fluentd/error/error
    append true
    time_slice_format %Y%m%d
    format json
    include_time_key true
    compress gzip
  </store>
</match>

# Application logs to centralized logging
<match orm.application>
  @type elasticsearch
  @id application_elasticsearch
  host elasticsearch.your-company.com
  port 9200
  index_name orm-calculator-application
  type_name _doc
  time_key timestamp
  time_key_format %Y-%m-%dT%H:%M:%S.%L%z
  include_timestamp true
  logstash_format true
  logstash_prefix orm-calculator-application
  logstash_dateformat %Y.%m.%d
  <buffer>
    @type file
    path /var/log/fluentd/buffer/application
    flush_mode interval
    flush_interval 30s
    chunk_limit_size 64m
    queue_limit_length 128
    retry_type exponential_backoff
    retry_wait 2s
    retry_max_interval 120s
    retry_max_times 15
  </buffer>
</match>

# Performance logs to time-series database
<match orm.performance>
  @type influxdb
  @id performance_influxdb
  host influxdb.your-company.com
  port 8086
  database orm_calculator_metrics
  measurement performance
  tag_keys ["hostname", "environment", "service_name"]
  time_key timestamp
  time_precision s
  <buffer>
    @type file
    path /var/log/fluentd/buffer/performance
    flush_mode interval
    flush_interval 15s
    chunk_limit_size 32m
    queue_limit_length 64
  </buffer>
</match>

# Access logs to analytics
<match orm.access>
  @type elasticsearch
  @id access_elasticsearch
  host elasticsearch.your-company.com
  port 9200
  index_name orm-calculator-access
  type_name _doc
  logstash_format true
  logstash_prefix orm-calculator-access
  logstash_dateformat %Y.%m.%d
  <buffer>
    @type file
    path /var/log/fluentd/buffer/access
    flush_mode interval
    flush_interval 60s
    chunk_limit_size 64m
    queue_limit_length 128
  </buffer>
</match>

# Database logs
<match orm.database.**>
  @type file
  @id database_file_output
  path /var/log/orm-calculator/fluentd/database/database
  append true
  time_slice_format %Y%m%d
  format json
  include_time_key true
  compress gzip
</match>

# System logs
<match orm.system>
  @type file
  @id system_file_output
  path /var/log/orm-calculator/fluentd/system/system
  append true
  time_slice_format %Y%m%d
  format json
  include_time_key true
  compress gzip
</match>

# Nginx logs
<match orm.nginx.**>
  @type file
  @id nginx_file_output
  path /var/log/orm-calculator/fluentd/nginx/nginx
  append true
  time_slice_format %Y%m%d
  format json
  include_time_key true
  compress gzip
</match>

# Catch-all for any unmatched logs
<match **>
  @type file
  @id catchall_output
  path /var/log/orm-calculator/fluentd/misc/misc
  append true
  time_slice_format %Y%m%d
  format json
  include_time_key true
  compress gzip
</match>