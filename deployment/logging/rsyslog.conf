# Rsyslog configuration for ORM Capital Calculator Engine
# Ensures structured logging and compliance with CERT-In requirements

# Global configuration
$ModLoad imuxsock # provides support for local system logging
$ModLoad imklog   # provides kernel logging support
$ModLoad imfile   # provides file monitoring support

# Set default permissions for log files
$FileOwner orm-calculator
$FileGroup orm-calculator
$FileCreateMode 0644
$DirCreateMode 0755

# Use traditional timestamp format for compatibility
$ActionFileDefaultTemplate RSYSLOG_TraditionalFileFormat

# Define custom templates for structured logging
$template ORMCalculatorFormat,"%timegenerated% %HOSTNAME% %syslogtag% %msg%\n"
$template ORMCalculatorJSON,"{\"timestamp\":\"%timegenerated:::date-rfc3339%\",\"hostname\":\"%HOSTNAME%\",\"service\":\"%syslogtag%\",\"level\":\"%syslogpriority-text%\",\"message\":\"%msg:::drop-last-lf%\"}\n"

# Application-specific logging rules
# ORM Calculator application logs
if $programname == 'orm-calculator' then {
    # Separate logs by severity
    if $syslogpriority-text == 'err' or $syslogpriority-text == 'crit' or $syslogpriority-text == 'alert' or $syslogpriority-text == 'emerg' then {
        /var/log/orm-calculator/error/application-error.log;ORMCalculatorJSON
    }
    
    if $syslogpriority-text == 'warning' then {
        /var/log/orm-calculator/warning/application-warning.log;ORMCalculatorJSON
    }
    
    if $syslogpriority-text == 'info' then {
        /var/log/orm-calculator/info/application-info.log;ORMCalculatorJSON
    }
    
    if $syslogpriority-text == 'debug' then {
        /var/log/orm-calculator/debug/application-debug.log;ORMCalculatorJSON
    }
    
    # All application logs to main file
    /var/log/orm-calculator/application.log;ORMCalculatorJSON
    
    # Stop processing after handling ORM Calculator logs
    stop
}

# Audit logs (special handling for compliance)
if $programname == 'orm-calculator-audit' then {
    # Audit logs must be tamper-evident and retained for 180+ days
    /var/log/orm-calculator/audit/audit.log;ORMCalculatorJSON
    
    # Forward audit logs to central SIEM/SOC
    @@soc.your-company.com:514;ORMCalculatorJSON
    
    stop
}

# Security logs
if $programname == 'orm-calculator-security' then {
    /var/log/orm-calculator/security/security.log;ORMCalculatorJSON
    
    # Forward security events to SOC immediately
    @@soc.your-company.com:514;ORMCalculatorJSON
    
    # Local security log for compliance
    /var/log/orm-calculator/security/local-security.log;ORMCalculatorJSON
    
    stop
}

# Performance logs
if $programname == 'orm-calculator-performance' then {
    /var/log/orm-calculator/performance/performance.log;ORMCalculatorJSON
    stop
}

# Access logs (HTTP requests)
if $programname == 'orm-calculator-access' then {
    /var/log/orm-calculator/access/access.log;ORMCalculatorJSON
    stop
}

# Database logs
if $programname == 'postgresql' then {
    /var/log/orm-calculator/database/postgresql.log;ORMCalculatorJSON
    
    # Forward database errors to monitoring
    if $syslogpriority-text == 'err' or $syslogpriority-text == 'crit' then {
        @@monitoring.your-company.com:514;ORMCalculatorJSON
    }
    
    stop
}

# System logs related to ORM Calculator
if $msg contains 'orm-calculator' then {
    /var/log/orm-calculator/system/system.log;ORMCalculatorJSON
}

# File monitoring for application log files
$InputFileName /opt/orm-calculator/logs/application.log
$InputFileTag orm-calculator:
$InputFileStateFile stat-orm-calculator-app
$InputFileSeverity info
$InputFileFacility local0
$InputRunFileMonitor

$InputFileName /opt/orm-calculator/logs/audit.log
$InputFileTag orm-calculator-audit:
$InputFileStateFile stat-orm-calculator-audit
$InputFileSeverity info
$InputFileFacility local1
$InputRunFileMonitor

$InputFileName /opt/orm-calculator/logs/security.log
$InputFileTag orm-calculator-security:
$InputFileStateFile stat-orm-calculator-security
$InputFileSeverity warning
$InputFileFacility local2
$InputRunFileMonitor

# Rate limiting to prevent log flooding
$SystemLogRateLimitInterval 10
$SystemLogRateLimitBurst 100

# Queue configuration for high-volume logging
$MainMsgQueueSize 10000
$MainMsgQueueHighWaterMark 8000
$MainMsgQueueLowWaterMark 2000
$MainMsgQueueDiscardMark 9000
$MainMsgQueueDiscardSeverity 4

# Network configuration for forwarding to SOC
$ActionSendStreamDriver gtls
$ActionSendStreamDriverMode 1
$ActionSendStreamDriverAuthMode x509/name
$ActionSendStreamDriverPermittedPeer soc.your-company.com

# Include all config files in /etc/rsyslog.d/
$IncludeConfig /etc/rsyslog.d/*.conf

# Default logging rules (keep at end)
auth,authpriv.*                 /var/log/auth.log
*.*;auth,authpriv.none          -/var/log/syslog
daemon.*                        -/var/log/daemon.log
kern.*                          -/var/log/kern.log
mail.*                          -/var/log/mail.log
user.*                          -/var/log/user.log

# Emergency messages to all users
*.emerg                         :omusrmsg:*

# High priority messages to console
*.=debug;\
        auth,authpriv.none;\
        news.none;mail.none     -/var/log/debug
*.=info;*.=notice;*.=warn;\
        auth,authpriv.none;\
        cron,daemon.none;\
        mail,news.none          -/var/log/messages